# Test: Dockerfile structure and build process

# 1. Test that the Dockerfile builds successfully
docker build -t zendo-app-test -f ../Dockerfile .

# 2. Test that the image exposes port 3000
test "$(docker inspect --format='{{(index (index .Config.ExposedPorts "3000/tcp")}}' zendo-app-test)" = "map[]"

# 3. Test that the image uses the correct user
docker run --rm zendo-app-test id -u | grep 1001

# 4. Test that the image contains the expected files
docker run --rm zendo-app-test test -f /app/package.json
docker run --rm zendo-app-test test -f /app/next.config.js
docker run --rm zendo-app-test test -d /app/node_modules
docker run --rm zendo-app-test test -d /app/public
docker run --rm zendo-app-test test -d /app/.next

# 5. Test that the container starts and responds on port 3000
docker run -d --name zendo-app-test-container -p 3000:3000 zendo-app-test
sleep 10
curl -f http://localhost:3000 || (echo "App did not start" && exit 1)
docker stop zendo-app-test-container
docker rm zendo-app-test-container